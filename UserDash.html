<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EcoSafar • User Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>

<body class="dashboard-bg">

<div class="card">
    <img src="logo.png" class="logo" alt="EcoSafar Logo">

    <h2>Welcome, <span id="userName">User</span></h2>
    <p>Your RFID UID: <strong id="userUID">----</strong></p>

    <div class="stats">
        <div class="stat-box">
            <div class="stat-title">EcoPoints</div>
            <div class="stat-value" id="userPoints">0</div>
        </div>

        <div class="stat-box">
            <div class="stat-title">Total Waste (kg)</div>
            <div class="stat-value" id="userWeight">0</div>
        </div>

        <div class="stat-box highlight">
            <div class="stat-title">Redeem Value</div>
            <div class="stat-value">₹<span id="moneyValue">0</span></div>
        </div>
    </div>

    <button class="btn redeem-btn" onclick="redeemPoints()">
        Convert EcoPoints to Money
    </button>

    <div class="history-container">
        <h4>History</h4>
        <div id="historyList"></div>
    </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const username = params.get("uid");

document.getElementById("userUID").innerText = username || "----";

const RATE = 10;

async function loadUser() {
    const res = await fetch(`/api/user/${username}`);
    const data = await res.json();

    document.getElementById("userName").innerText = data.user.username;
    document.getElementById("userPoints").innerText = data.user.points;
    document.getElementById("userWeight").innerText = data.user.totalWeight;
    document.getElementById("moneyValue").innerText =
        Math.floor(data.user.points / RATE);

    const history = document.getElementById("historyList");
    history.innerHTML = "";

    data.history.forEach(h => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerText = `${h.date} — ${h.weight}kg → ${h.points} pts`;
        history.appendChild(div);
    });
}

async function redeemPoints() {
    const res = await fetch("/api/redeem", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ username })
    });

    const data = await res.json();

    if(data.error){
        alert(data.error);
    } else {
        alert(`Redeemed ₹${data.amount}`);
        loadUser();
    }
}

if(username) loadUser();
</script>

</body>
</html>
