//user dashboard

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EcoSafar • User Dashboard</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --green-dark:#0b3d0f;
  --green-main:#145A13;
  --accent:#2ecc71;
}
*{box-sizing:border-box;font-family:Inter,sans-serif;}
body{margin:0;background:linear-gradient(135deg,#dff3ea,#c9ebd9);min-height:100vh;display:flex;justify-content:center;padding:40px 0;}
.card{background:#fff;width:420px;padding:35px 28px;border-radius:26px;box-shadow:0 18px 45px rgba(0,0,0,.18);text-align:center;}
.logo{width:110px;margin-bottom:16px;}
h2{color:var(--green-main);margin-bottom:6px;}
.uid{font-size:14px;margin-bottom:22px;color:#4f5e57;}
.stats{display:flex;gap:12px;margin-bottom:22px;}
.stat{flex:1;background:#eef9f1;padding:14px;border-radius:14px;}
.stat h4{font-size:13px;margin-bottom:6px;color:#4f5e57;}
.stat div{font-size:22px;font-weight:700;color:var(--green-main);}
.convert-box{background:#f0faf3;padding:16px;border-radius:14px;margin-bottom:24px;}
.convert-box p{margin:6px 0;font-weight:600;}
.history{text-align:left;}
.history h3{margin-bottom:12px;color:var(--green-dark);}
table{width:100%;border-collapse:collapse;font-size:14px;}
th,td{padding:8px;text-align:center;}
th{background:#e6f4ea;color:#145A13;}
tr:nth-child(even){background:#f5fbf7;}
.empty{background:#eef9f1;padding:10px;border-radius:8px;font-size:14px;}
</style>
</head>
<body>

<div class="card">
  <img src="logo.png" class="logo">

  <h2>Welcome, <span id="userName">---</span></h2>
  <div class="uid">RFID UID: <b id="userUID">----</b></div>

  <div class="stats">
    <div class="stat">
      <h4>Total EcoPoints</h4>
      <div id="points">0</div>
    </div>
    <div class="stat">
      <h4>Total Waste (g)</h4>
      <div id="weight">0</div>
    </div>
  </div>

  <div class="convert-box">
    <p>Redeem Value</p>
    <p>₹ <span id="money">0</span></p>
    <p style="font-size:12px;color:#555;">(100g = ₹10)</p>
  </div>

  <div class="history">
    <h3>Transaction History</h3>
    <div id="historyList" class="empty">Waiting for ESP32 data…</div>
  </div>
</div>

<script>
  // ---------- FIREBASE INIT ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBK72ROuOs4fDc5p5CFaHSWwW8oQZwEL-g",
    authDomain: "ecosafar-b8e9b.firebaseapp.com",
    databaseURL: "https://ecosafar-b8e9b-default-rtdb.firebaseio.com",
    projectId: "ecosafar-b8e9b",
    storageBucket: "ecosafar-b8e9b.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcdefg"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---------- DASHBOARD ELEMENTS ----------
  const userNameEl = document.getElementById("userName");
  const userUIDEl = document.getElementById("userUID");
  const pointsEl = document.getElementById("points");
  const weightEl = document.getElementById("weight");
  const moneyEl = document.getElementById("money");
  const historyDiv = document.getElementById("historyList");

  let currentUserRef = null;
  let historyRef = null;

  // ---------- LISTEN FOR LAST ACTIVE UID ----------
  db.ref("lastActiveUID").on("value", snap => {
    const uid = snap.val();
    if(uid) loadUserData(uid);
    else resetDashboard();
  });

  // ---------- LOAD USER DATA ----------
  function loadUserData(uid){
    if(currentUserRef) currentUserRef.off();
    if(historyRef) historyRef.off();

    currentUserRef = db.ref("users/" + uid);
    historyRef = db.ref("history/" + uid);

    currentUserRef.on("value", snap => {
      if(!snap.exists()){ resetDashboard(); return; }
      const d = snap.val();
      userUIDEl.innerText = uid;
      userNameEl.innerText = d.name || "User";
      weightEl.innerText = d.totalWeight || 0;
      pointsEl.innerText = d.points || 0;
      moneyEl.innerText = ((d.totalWeight || 0)/100*10).toFixed(2);
    });

    historyRef.on("value", snap => {
      const h = snap.val() || {};
      const entries = Object.values(h).reverse();
      if(entries.length === 0){
        historyDiv.innerHTML = "<div class='empty'>No transactions yet</div>";
        return;
      }

      let html = `<table>
        <tr><th>#</th><th>Waste (g)</th><th>EcoPoints</th></tr>`;
      entries.forEach((e,i)=>{
        html += `<tr>
          <td>${i+1}</td>
          <td>${e.weight}</td>
          <td>+${e.points}</td>
        </tr>`;
      });
      html += "</table>";
      historyDiv.innerHTML = html;
    });
  }

  // ---------- RESET DASHBOARD ----------
  function resetDashboard(){
    userUIDEl.innerText = "----";
    userNameEl.innerText = "---";
    weightEl.innerText = 0;
    pointsEl.innerText = 0;
    moneyEl.innerText = 0;
    historyDiv.innerHTML = "<div class='empty'>Waiting for ESP32 data…</div>";
  }
</script>

</body>
</html>