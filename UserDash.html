<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ================= BASIC SETUP ================= -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EcoSafar • User Dashboard</title>

  <!-- ================= GOOGLE FONT ================= -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- ================= FIREBASE SDKs (STEP 1) ================= -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- ================= STYLES ================= -->
  <style>
    :root{
      --green-dark:#0b3d0f;
      --green-main:#145A13;
      --accent:#2ecc71;
    }
    *{box-sizing:border-box;font-family:Inter,sans-serif;}
    body{
      margin:0;
      background:linear-gradient(135deg,#dff3ea,#c9ebd9);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:40px 0;
    }
    .card{
      background:#fff;
      width:420px;
      padding:35px 28px;
      border-radius:26px;
      box-shadow:0 18px 45px rgba(0,0,0,.18);
      text-align:center;
    }
    .logo{width:110px;margin-bottom:16px;}
    h2{color:var(--green-main);margin-bottom:6px;}
    .uid{font-size:14px;margin-bottom:22px;color:#4f5e57;}
    .stats{display:flex;gap:12px;margin-bottom:22px;}
    .stat{flex:1;background:#eef9f1;padding:14px;border-radius:14px;}
    .stat h4{font-size:13px;margin-bottom:6px;color:#4f5e57;}
    .stat div{font-size:22px;font-weight:700;color:var(--green-main);}
    .convert-box{background:#f0faf3;padding:16px;border-radius:14px;margin-bottom:24px;}
    .convert-box p{margin:6px 0;font-weight:600;}
    .history{text-align:left;}
    .history h3{margin-bottom:12px;color:var(--green-dark);}
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:8px;text-align:center;}
    th{background:#e6f4ea;color:#145A13;}
    tr:nth-child(even){background:#f5fbf7;}
    .empty{background:#eef9f1;padding:10px;border-radius:8px;font-size:14px;}
  </style>
</head>

<body>

  <!-- ================= UI ================= -->
  <div class="card">
    <img src="logo.png" class="logo">

    <h2>Welcome, <span id="userName">---</span></h2>
    <div class="uid">RFID UID: <b id="userUID">----</b></div>

    <div class="stats">
      <div class="stat">
        <h4>Total EcoPoints</h4>
        <div id="points">0</div>
      </div>
      <div class="stat">
        <h4>Total Waste (g)</h4>
        <div id="weight">0</div>
      </div>
    </div>

    <div class="convert-box">
      <p>Redeem Value</p>
      <p>₹ <span id="money">0</span></p>
      <p style="font-size:12px;color:#555;">(100g = ₹10)</p>
    </div>

    <div class="history">
      <h3>Transaction History</h3>
      <div id="historyList" class="empty">Waiting for data…</div>
    </div>
  </div>

  <!-- ================= FIREBASE + LOGIC (STEP 2 → END) ================= -->
  <script>
    /* ---------- STEP 2: FIREBASE CONFIG ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyC-ukbAaOdiEb65v9F7FuBzT0TTRoQHyxw",
      authDomain: "ecosafar-3da96.firebaseapp.com",
      databaseURL: "https://ecosafar-3da96-default-rtdb.firebaseio.com",
      projectId: "ecosafar-3da96",
      storageBucket: "ecosafar-3da96.firebasestorage.app",
      messagingSenderId: "972209472560",
      appId: "1:972209472560:web:39fcc096311b3006c6d9f5"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const db = firebase.database();

    /* ---------- STEP 3: GET UID FROM URL ---------- */
    const uid = new URLSearchParams(window.location.search).get("uid");

    /* ---------- STEP 4: ELEMENT REFERENCES ---------- */
    const userNameEl = document.getElementById("userName");
    const userUIDEl  = document.getElementById("userUID");
    const pointsEl   = document.getElementById("points");
    const weightEl   = document.getElementById("weight");
    const moneyEl    = document.getElementById("money");
    const historyDiv = document.getElementById("historyList");

    if (uid) {
      loadUser(uid);
    } else {
      resetDashboard();
    }

    /* ---------- STEP 5: LOAD USER DATA ---------- */
    function loadUser(uid) {
      const userRef = db.ref("users/" + uid);
      const historyRef = db.ref("history/" + uid);

      userRef.on("value", snap => {
        if (!snap.exists()) return resetDashboard();

        const d = snap.val();
        const weight = Number(d.totalWeight) || 0;
        const points = Number(d.EcoPoints) || 0;

        userUIDEl.innerText = uid;
        userNameEl.innerText = d.name || "User";
        weightEl.innerText = weight;
        pointsEl.innerText = points;
        moneyEl.innerText = ((weight / 100) * 10).toFixed(2);
      });

      historyRef.on("value", snap => {
        const h = snap.val();
        if (!h) {
          historyDiv.innerHTML = "<div class='empty'>No transactions yet</div>";
          return;
        }

        let html = `
          <table>
            <tr><th>#</th><th>Waste (g)</th><th>EcoPoints</th></tr>
        `;

        Object.values(h).reverse().forEach((e, i) => {
          html += `
            <tr>
              <td>${i + 1}</td>
              <td>${e.weight || 0}</td>
              <td>+${e.points || 0}</td>
            </tr>
          `;
        });

        html += "</table>";
        historyDiv.innerHTML = html;
      });
    }

    /* ---------- STEP 6: RESET ---------- */
    function resetDashboard() {
      userUIDEl.innerText = "----";
      userNameEl.innerText = "---";
      weightEl.innerText = 0;
      pointsEl.innerText = 0;
      moneyEl.innerText = 0;
      historyDiv.innerHTML = "<div class='empty'>Waiting for data…</div>";
    }
  </script>

</body>
</html>
