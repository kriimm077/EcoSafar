 <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EcoSafar ‚Ä¢ Admin Dashboard</title>

<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f0faf5;
  margin: 0;
  padding: 30px 20px;
  color: #145A13;
  text-align: center;
}

#logo {
  width: 100px;
  margin-bottom: 20px;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
  100% { transform: translateY(0); }
}

h2 {
  font-size: 28px;
  margin-bottom: 20px;
}

#alertBox {
  display: none;
  max-width: 420px;
  margin: 0 auto 20px;
  background: #fee2e2;
  color: #991b1b;
  padding: 14px;
  border-radius: 10px;
  font-weight: 600;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.bin-card {
  max-width: 420px;
  margin: 0 auto 30px;
  background: #ffffff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.bin-title {
  font-weight: 600;
  margin-bottom: 15px;
}

.bin-row {
  display: flex;
  justify-content: space-between;
  margin: 10px 0;
}

.progress {
  width: 100%;
  height: 16px;
  background: #e5f3ea;
  border-radius: 8px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #22c55e, #15803d);
  transition: width 0.5s ease;
}

table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #ffffff;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

th, td {
  padding: 14px;
  text-align: center;
}

th {
  background: #dff3ea;
  text-transform: uppercase;
  font-size: 14px;
}

tr:nth-child(even) td {
  background: #f7fcf8;
}
</style>
</head>

<body>

<img src="logo.png" id="logo" alt="EcoSafar Logo">
<h2>EcoSafar ‚Äì Admin Dashboard</h2>

<div id="alertBox">‚ö†Ô∏è BIN001 IS FULL ‚Äì COLLECTION REQUIRED</div>

<div class="bin-card">
  <div class="bin-title">üóëÔ∏è BIN001 Status</div>

  <div class="bin-row">
    <span>Distance</span>
    <strong><span id="distance">--</span> cm</strong>
  </div>

  <div class="bin-row">
    <span>Fill Level</span>
    <strong><span id="fill">--</span> %</strong>
  </div>

  <div class="progress">
    <div class="progress-bar" id="fillBar"></div>
  </div>

  <div class="bin-row" style="font-size:14px;margin-top:10px;">
    <span>Last Updated</span>
    <span id="lastUpdated">--</span>
  </div>
</div>

<table>
<thead>
<tr>
<th>Rank</th>
<th>RFID UID</th>
<th>Name</th>
<th>City</th>
<th>Total Waste (g)</th>
<th>EcoPoints</th>
</tr>
</thead>
<tbody id="users">
<tr><td colspan="6">Loading...</td></tr>
</tbody>
</table>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

<!-- Firebase Config -->
<script src="firebase-config.js"></script>

<script>
const messaging = firebase.messaging();

// üîî Ask notification permission
messaging.requestPermission()
.then(() => {
  console.log("Notification permission granted.");
  return messaging.getToken({
    vapidKey: "BA4P4hdv85OrkXnA8Jnoj67SVcRtvIxbyH_7H7KDlxIVrXoBj9OAir4PcaBfsaxZMUN4WoynTIB23DcD6Dp-8"
  });
})
.then((token) => {
  console.log("FCM Token:", token);
  // Save token in database
  database.ref("adminTokens").push(token);
})
.catch((err) => {
  console.log("Notification permission denied", err);
});

// Foreground message handler
messaging.onMessage((payload) => {
  console.log("Message received:", payload);
  alert(payload.notification.title + "\n" + payload.notification.body);
});

// BIN DATA LISTENER
database.ref("admins/Anand/bins/BIN001").on("value", snap => {
  const d = snap.val();
  if (!d) return;

  document.getElementById("distance").innerText = d.distanceCM;
  document.getElementById("fill").innerText = d.fillPercentage;
  document.getElementById("fillBar").style.width = d.fillPercentage + "%";

  if (d.lastUpdated) {
    const ts = d.lastUpdated < 1000000000000
      ? d.lastUpdated * 1000
      : d.lastUpdated;
    document.getElementById("lastUpdated").innerText =
      new Date(ts).toLocaleString();
  }

  if (d.fillPercentage >= 85) {
    document.getElementById("alertBox").style.display = "block";

    // Local notification if open
    if (Notification.permission === "granted") {
      new Notification("EcoSafar Alert", {
        body: "BIN001 is above 85% full. Collection required!",
        icon: "logo.png"
      });
    }
  } else {
    document.getElementById("alertBox").style.display = "none";
  }
});

// USERS TABLE
database.ref("users").on("value", snapshot => {
  let users = [];

  snapshot.forEach(child => {
    const data = child.val();
    if (!data || !data.name) return;

    users.push({
      uid: child.key,
      name: data.name,
      city: data.city || "-",
      TotalWeight: Number(data.TotalWeight || 0),
      Ecopoints: Number(data.Ecopoints || 0)
    });
  });

  users.sort((a,b) => b.Ecopoints - a.Ecopoints);

  document.getElementById("users").innerHTML = users.map((u,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${u.uid}</td>
      <td>${u.name}</td>
      <td>${u.city}</td>
      <td>${u.TotalWeight.toFixed(2)}</td>
      <td>${u.Ecopoints.toFixed(2)}</td>
    </tr>
  `).join("") || "<tr><td colspan='6'>No users</td></tr>";
});
</script>

</body>
</html>
