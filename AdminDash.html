<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EcoSafar • Admin Dashboard</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body {
  font-family: "Segoe UI", system-ui, sans-serif;
  background: #f4fbf7;
  margin: 0;
  padding: 32px 18px;
  color: #1f3d2b;
}

/* Header */
.header {
  text-align: center;
  margin-bottom: 28px;
}
#logo {
  width: 90px;
  animation: float 3s ease-in-out infinite;
}
@keyframes float {
  0% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
  100% { transform: translateY(0); }
}
h2 {
  margin: 10px 0 0;
  font-weight: 600;
}

/* Bin Card */
.bin-card {
  max-width: 620px;
  margin: 0 auto 30px;
  background: #ffffff;
  border-radius: 14px;
  padding: 20px 22px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
}
.bin-title {
  font-weight: 600;
  margin-bottom: 12px;
}

/* Progress */
.progress {
  width: 100%;
  height: 22px;
  background: #e6efe9;
  border-radius: 20px;
  overflow: hidden;
}
.progress-bar {
  height: 100%;
  width: 0%;
  border-radius: 20px;
  transition: width 1s ease, background 0.4s ease;
}

.bin-meta {
  margin-top: 10px;
  font-size: 14px;
  color: #355f4b;
}

/* Button */
.actions {
  text-align: center;
  margin-bottom: 26px;
}
button {
  background: #1e8449;
  color: #fff;
  border: none;
  padding: 10px 18px;
  font-size: 14px;
  border-radius: 8px;
  cursor: pointer;
}
button:hover {
  background: #166a3a;
}

/* Table */
table {
  width: 100%;
  background: #ffffff;
  border-radius: 12px;
  border-collapse: collapse;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
}
th, td {
  padding: 14px;
  font-size: 14px;
  text-align: center;
}
th {
  background: #e3f3eb;
  font-weight: 600;
  text-transform: uppercase;
}
tr:nth-child(even) td {
  background: #f7fcf9;
}
</style>
</head>

<body>

<div class="header">
  <img src="logo.png" id="logo">
  <h2>EcoSafar – Admin Dashboard (Anand)</h2>
</div>

<!-- BIN STATUS -->
<div class="bin-card">
  <div class="bin-title">Dustbin Status • BIN001</div>
  <div class="progress">
    <div id="binBar" class="progress-bar"></div>
  </div>
  <div class="bin-meta">
    Fill Level: <strong><span id="fillPercentage">0</span>%</strong>
    &nbsp;•&nbsp;
    Distance: <span id="distanceCM">0</span> cm
  </div>
</div>

<div class="actions">
  <button onclick="downloadCSV()">Download CSV Report</button>
</div>

<!-- USERS TABLE -->
<table>
<thead>
<tr>
  <th>Rank</th>
  <th>RFID UID</th>
  <th>Name</th>
  <th>City</th>
  <th>Total Waste (g)</th>
  <th>EcoPoints</th>
</tr>
</thead>
<tbody id="users">
<tr><td colspan="6">Loading...</td></tr>
</tbody>
</table>

<script>
/* Firebase Init */
firebase.initializeApp({
  apiKey: "AIzaSyBK72ROuOs4fDc5p5CFaHSWwW8oQZwEL-g",
  databaseURL: "https://ecosafar-b8e9b-default-rtdb.firebaseio.com",
  projectId: "ecosafar-b8e9b"
});

const db = firebase.database();

/* BIN LISTENER */
db.ref("admins/Anand/bins/BIN001").on("value", snap => {
  if (!snap.exists()) return;

  const d = snap.val();
  const percent = Number(d.fillPercentage || 0);
  const distance = Number(d.distanceCM || 0);

  document.getElementById("fillPercentage").innerText = percent.toFixed(0);
  document.getElementById("distanceCM").innerText = distance;

  const bar = document.getElementById("binBar");
  bar.style.width = percent + "%";

  if (percent < 50) bar.style.background = "#2ecc71";
  else if (percent < 80) bar.style.background = "#f1c40f";
  else bar.style.background = "#e74c3c";
});

/* USERS TABLE */
let cachedUsers = [];

db.ref("users").on("value", snapshot => {
  let users = [];

  snapshot.forEach(child => {
    const d = child.val();
    if (!d || !d.name) return;

    users.push({
      uid: child.key,
      name: d.name,
      city: d.city,
      weight: Number(d.TotalWeight || 0),
      points: Number(d.Ecopoints || 0)
    });
  });

  users.sort((a, b) => b.points - a.points);
  cachedUsers = users;

  let html = "";
  users.forEach((u, i) => {
    html += `
      <tr>
        <td>${i + 1}</td>
        <td>${u.uid}</td>
        <td>${u.name}</td>
        <td>${u.city}</td>
        <td>${u.weight.toFixed(2)}</td>
        <td>${u.points.toFixed(2)}</td>
      </tr>`;
  });

  document.getElementById("users").innerHTML =
    html || "<tr><td colspan='6'>No users found</td></tr>";
});

/* CSV */
function downloadCSV() {
  let csv = "Rank,UID,Name,City,TotalWeight,EcoPoints\n";
  cachedUsers.forEach((u, i) => {
    csv += `${i+1},${u.uid},${u.name},${u.city},${u.weight},${u.points}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "EcoSafar_Report.csv";
  a.click();
}
</script>

</body>
</html>
